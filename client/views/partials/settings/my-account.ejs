<head>
  <link href="/css/general.css" rel="stylesheet" />
  <link href="/css/client-my-profile.css" rel="stylesheet" />
</head>

<form id="profile-form" method="POST" action="/my-account">
  <input type="file" id="uploadFoto" accept="image/*" style="display: none" />
  <div id="pfp-container" style="cursor: pointer; text-align: center">
    <img id="pfpImg" src="/images/my-account.png" alt="pfp" />
    <p id="pfpChange">Alterar Imagem</p>
  </div>
  <h2 class="fw-bold mb-4" id="personalData">Dados Pessoais</h2>
  <script>
    // Quando clica no container, abre o seletor de ficheiros
    document
      .getElementById("pfp-container")
      .addEventListener("click", function () {
        document.getElementById("uploadFoto").click();
      });

    // Quando seleciona uma imagem, atualiza a imagem visível
    document
      .getElementById("uploadFoto")
      .addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("pfpImg").src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
  </script>
  <div>
    <input
      class="form-group"
      type="text"
      name="name"
      placeholder="Nome e apelido"
      value="<%= user.name %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="birthdate"
      placeholder="Idade"
      value="<%= user.birthdate %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="username"
      placeholder="Nome de Utilizador"
      value="<%= user.username %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="tel"
      name="phone"
      placeholder="Nº Telemóvel"
      value="<%= user.phone %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="address"
      placeholder="Morada"
      value="<%= user.address %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="municipality"
      placeholder="Localidade"
      value="<%= user.municipality %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="postcode"
      placeholder="Código Postal"
      value="<%= user.postcode %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="nif"
      placeholder="NIF"
      value="<%= user.nif %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="email"
      placeholder="E-mail"
      value="<%= user.email %>"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="confirmEmail"
      placeholder="Confirmar E-mail"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="currentPassword"
      placeholder="Palavra-passe Atual"
    />
  </div>
  <div>
    <input
      class="form-group"
      type="text"
      name="newPassword"
      placeholder=" Nova Palavra-passe"
    />
  </div>

  <br />
  <br />
  <div class="actions-btn d-flex">
    <div class="d-flex justify-content-between gap-3 buttonWidth">
      <button
        type="button"
        class="buttonWidth btn btn-black"
        onclick="window.location.href='/'"
      >
        Voltar
      </button>
      <button type="submit" class="buttonWidth btn btn-blue">Guardar</button>
    </div>
  </div>
  <br />
  <div class="actions-btn d-grid buttonWidth">
    <button class="btn btn-delete">Eliminar Conta</button>
  </div>

  <script src="/js/client-my-profile.js"></script>
</form>

<div
  id="notification-perfil-att"
  class="notificationperfilatt"
  style="display: none"
>
  <div class="alert">!</div>
  <div class="content">
    <div class="title">Notificação</div>
    <div class="message">Perfil editado com sucesso</div>
  </div>
  <div class="progress-bar-perfil-att"></div>
</div>

<script>
  // Verifica se há notificação de remoção a ser exibida
  if (sessionStorage.getItem("mostrarNotificacaoPerfilAtt") === "true") {
    const notificationPerfilAtt = document.getElementById(
      "notification-perfil-att"
    );
    notificationPerfilAtt.style.display = "flex";

    // Remove o gatilho da sessão para não repetir
    sessionStorage.removeItem("mostrarNotificacaoPerfilAtt");

    // Reinicia a animação da progress bar (necessário para casos de reuso)
    const progressBar = notificationPerfilAtt.querySelector(
      ".progress-bar-perfil-att"
    );
    progressBar.style.animation = "none";
    progressBar.offsetHeight; // forçar reflow
    progressBar.style.animation = null;

    // Esconde após x segundos
    setTimeout(() => {
      notificationPerfilAtt.classList.add("hide");
      setTimeout(() => {
        notificationPerfilAtt.remove();
      }, 500); // tempo da transição de opacidade
    }, 5000); // tempo do alerta
  }
</script>

<!--<script>
  function mostrarNotificacaoPerfilAtt() {
    sessionStorage.setItem("mostrarNotificacaoPerfilAtt", "true");
    location.reload(); // ou enviar o formulário e redirecionar de volta
  }
</script>-->

<script>
  // upload preview
  document.getElementById("pfp-container").addEventListener("click", () => {
    document.getElementById("uploadFoto").click();
  });
  document.getElementById("uploadFoto").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (ev) {
        document.getElementById("pfpImg").src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
</script>
