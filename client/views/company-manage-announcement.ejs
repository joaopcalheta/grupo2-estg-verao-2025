<!-- ../views/company-manage-announcement.ejs -->
<head>
  <link href="/css/general.css" rel="stylesheet" />
  <link href="/css/form.css" rel="stylesheet" />
</head>

<div class="container-ad">
  <h2 class="text-center my-4">Gerir An√∫ncio</h2>
  <form id="editAnuncioForm" method="POST" action="/company-manage-announcement/<%= announcement._id %>">
    
    <label>
      Nome da profiss√£o
      <input type="text" name="job_name" id="job_name" value="<%= announcement.job_name %>" required minlength="3" maxlength="100" />
    </label>

    <label>
      Categoria
      <select name="category" id="category" required>
        <option value="">-- Selecione uma op√ß√£o --</option>
        <!-- op√ß√µes (j√° inclu√≠das corretamente com selected) -->
        <!-- ... [continua igual ao seu c√≥digo, com todas as op√ß√µes e selected j√° aplicados] -->
        <!-- mantido sem altera√ß√£o aqui -->
      </select>
    </label>

    <label>
      Tipo de contrato
      <select name="type" id="type" required>
        <option value="">-- Selecione uma op√ß√£o --</option>
        <option value="Emprego" <%= announcement.type === 'Emprego' ? 'selected' : '' %>>Emprego</option>
        <option value="Est√°gio" <%= announcement.type === 'Est√°gio' ? 'selected' : '' %>>Est√°gio</option>
      </select>
    </label>

    <label>
      Concelho
      <select name="municipality" id="municipality" required>
        <!-- op√ß√µes mantidas com selected -->
        <!-- ... -->
      </select>
    </label>

    <label>
      Freguesia
      <select name="freg" id="freg" required>
        <!-- op√ß√µes mantidas com selected -->
        <!-- ... -->
      </select>
    </label>

    <label>
      Morada
      <input type="text" name="address" id="address" value="<%= announcement.address %>" required />
    </label>

    <label>
      C√≥digo postal
      <input
        type="text"
        name="postcode"
        id="postcode"
        value="<%= announcement.postcode %>"
        required
        pattern="[0-9]{4}-[0-9]{3}"
        title="Formato: 1234-567"
      />
    </label>

    <label>
      Regime
      <select name="regime" id="regime" required>
        <option value="">-- Selecione uma op√ß√£o --</option>
        <option value="Full-Time" <%= announcement.regime === 'Full-Time' ? 'selected' : '' %>>Full-Time</option>
        <option value="Part-Time" <%= announcement.regime === 'Part-Time' ? 'selected' : '' %>>Part-Time</option>
      </select>
    </label>

    <label>
      Escolaridade
      <select name="education_level" required>
        <option value="">Selecione uma op√ß√£o</option>
        <option value="ensino b√°sico" <%= announcement.education_level === 'ensino b√°sico' ? 'selected' : '' %>>Ensino b√°sico</option>
        <option value="ensino secund√°rio" <%= announcement.education_level === 'ensino secund√°rio' ? 'selected' : '' %>>Ensino secund√°rio</option>
        <option value="ensino superior" <%= announcement.education_level === 'ensino superior' ? 'selected' : '' %>>Ensino superior</option>
      </select>
    </label>

    <div class="mb-3">
      <label>L√≠nguas</label>
      <div class="d-flex flex-wrap gap-3">
        <!-- os checkboxes j√° est√£o corretos e funcionam -->
      </div>
    </div>

    <label>
      Sal√°rio
      <input type="number" name="salary" min="0" step="0.01" required value="<%= announcement.salary %>" />
    </label>

    <label>Hor√°rio de trabalho</label>
    <div class="d-inline-flex p-2 gap-5">
      <div class="form-group">
        <label for="inicio">Hor√°rio de In√≠cio:</label>
        <input type="time" id="inicio" name="schedule[startTime]" value="<%= announcement.schedule['startTime'] %>" />
      </div>

      <div class="form-group">
        <label for="fim">Hor√°rio de T√©rmino:</label>
        <input type="time" id="fim" name="schedule[endTime]" value="<%= announcement.schedule['endTime'] %>" />
      </div>
    </div>

    <label>
      Prazo de candidatura
      <input type="date" name="end_date" id="end_date" required value="<%= announcement.end_date.toISOString().split('T')[0] %>" />
    </label>

    <label>
      N√∫mero de vagas
      <input type="number" name="numberOfPositions" min="1" required value="<%= announcement.numberOfPositions %>" />
    </label>

    <label>
      Descri√ß√£o
      <textarea name="description" rows="5" id="description" required minlength="10"><%= announcement.description %></textarea>
    </label>

    <label>
      Alterar foto
      <input type="text" name="pic" value="<%= announcement.pic %>" />
    </label>

    <div class="actions-btn">
      <button type="button" class="btn btn-black" onclick="history.back()">Voltar</button>
      <button type="submit" class="btn btn-blue">Guardar</button>
    </div>

    <div class="actions-btn">
      <button id="deletebtn" type="button" class="btn btn-delete">Eliminar üóëÔ∏è</button>
    </div>
  </form>
</div>

<!-- Modal de confirma√ß√£o -->
<div class="modal" id="confirmModal" style="display: none;">
  <span class="close" onclick="closeModal()">&times;</span>
  <div class="icon">!</div>
  <h2>Tem certeza?</h2>
  <p>Voc√™ est√° prestes a excluir seu an√∫ncio. Esta a√ß√£o n√£o pode ser desfeita.</p>
  <div class="buttons">
    <button class="btn-black btn-small" onclick="confirmDelete()">Sim, excluir</button>
    <button class="btn-cancel btn-small" onclick="closeModal()">Cancelar</button>
  </div>
</div>

<!-- Scripts -->
<script>
  const announcementId = "<%= announcement._id %>";

  document.getElementById("deletebtn").addEventListener("click", () => {
    document.getElementById("confirmModal").style.display = "block";
  });

  function closeModal() {
    document.getElementById("confirmModal").style.display = "none";
  }

  async function confirmDelete() {
    try {
      const response = await fetch(`/company-manage-announcement/${announcementId}`, {
        method: "DELETE"
      });

      if (response.ok) {
        sessionStorage.setItem('mostrarNotificacaoRemocao', 'true');
        window.location.href = "/settings?section=my-companies";
      } else {
        const errorText = await response.text();
        alert("Erro ao eliminar an√∫ncio: " + errorText);
      }
    } catch (err) {
      console.error("Erro ao eliminar:", err);
      alert("Erro interno ao tentar eliminar o an√∫ncio.");
    } finally {
      closeModal();
    }
  }

  // Valida√ß√£o: Data futura para o campo "end_date"
  document.getElementById("editAnuncioForm").addEventListener("submit", function (e) {
    const endDateInput = document.getElementById("end_date");
    const endDate = new Date(endDateInput.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (endDate <= today) {
      e.preventDefault();
      alert("A data de t√©rmino deve ser futura.");
      endDateInput.focus();
    }
  });
</script>
