<!-- ../views/manage-company.ejs -->

<head>
  <link href="/css/manage-company.css" rel="stylesheet" />
  <link href="/css/form.css" rel="stylesheet" />
</head>

<h2 class="text-center my-5 fw-bold">Gerir empresa</h2>

<form method="POST" action="/manage-company/<%= company._id %>">
  <label for="name">Nome da empresa</label>
  <input
    type="text"
    id="name"
    name="name"
    value="<%= company.name %>"
    required
    maxlength="100"
    placeholder="Ex: Tech Solutions Lda"
  />

  <label for="admin_usernames">
    Administradores (usernames, separados por v√≠rgula)
  </label>
  <input
    type="text"
    id="admin_usernames"
    name="admin_usernames"
    value="<%= company.admin_usernames.join(', ') %>"
    required
    placeholder="ex: user1, user2"
  />

  <label for="phone">Telefone</label>
  <input
    type="text"
    id="phone"
    name="phone"
    value="<%= company.phone %>"
    required
    pattern="^\+?[0-9\s\-().]{6,20}$"
    placeholder="+351 912 345 678"
    title="N√∫mero de telefone inv√°lido (ex: +351 912 345 678)"
  />

  <label for="nif">NIF</label>
  <input
    type="text"
    id="nif"
    name="nif"
    value="<%= company.nif %>"
    required
    pattern="^\d{9}$"
    title="O NIF deve conter exatamente 9 d√≠gitos"
    placeholder="123456789"
  />

  <label for="address">Morada</label>
  <input
    type="text"
    id="address"
    name="address"
    value="<%= company.address %>"
    required
    placeholder="Rua Exemplo, 123"
  />

  <label for="postcode">C√≥digo Postal</label>
  <input
    type="text"
    id="postcode"
    name="postcode"
    value="<%= company.postcode %>"
    required
    pattern="^\d{4}-\d{3}$"
    title="Formato esperado: 1234-567"
    placeholder="1234-567"
  />

  <label for="municipality">Concelho</label>
  <input
    type="text"
    id="municipality"
    name="municipality"
    value="<%= company.municipality %>"
    required
    placeholder="Lisboa"
  />

  <label for="about_us">Sobre n√≥s</label>
  <input
    type="text"
    id="about_us"
    name="about_us"
    value="<%= company.about_us %>"
    maxlength="1000"
    placeholder="Descri√ß√£o da empresa"
  />

  <label for="pic">Adicionar imagem</label>
  <input
    type="url"
    id="pic"
    name="pic"
    value="<%= company.pic %>"
    placeholder="https://example.com/logo.jpg"
    title="Insira uma URL v√°lida (come√ßando com http ou https)"
  />

  <div class="d-flex gap-3 mt-4">
    <div class="w-50">
      <button
        type="button"
        class="btn btn-black w-100"
        onclick="history.back()"
      >
        <h6 class="fw-bold">Voltar</h6>
      </button>
    </div>
    <div class="w-50">
      <button type="submit" class="btn btn-blue w-100">
        <h6 class="fw-bold">Guardar</h6>
      </button>
    </div>
  </div>

  <div class="mt-1 d-grid buttonWidth">
    <button id="deletebtn" type="button" class="btn btn-delete">
      Apagar empresa üóëÔ∏è
    </button>
  </div>
</form>

<div class="modal" id="confirmModal" style="display: none">
  <span class="close" onclick="closeModal()">&times;</span>
  <div class="icon">!</div>
  <h2>Tem certeza?</h2>
  <p>
    Voc√™ est√° prestes a excluir a sua empresa. Esta a√ß√£o n√£o pode ser desfeita.
  </p>
  <div class="buttons">
    <button class="delete-btn" onclick="confirmDelete()">Sim, excluir</button>
    <button class="cancel-btn" onclick="closeModal()">Cancelar</button>
  </div>
</div>

<!-- Script -->
<script>
  const companyId = "<%= company._id %>";

  document.getElementById("deletebtn").addEventListener("click", () => {
    document.getElementById("confirmModal").style.display = "block";
  });

  function closeModal() {
    document.getElementById("confirmModal").style.display = "none";
  }

  async function confirmDelete() {
    try {
      const response = await fetch(`/manage-company?id=${companyId}`, {
        method: "DELETE",
      });

      if (response.ok) {
        sessionStorage.setItem("mostrarNotificacaoDeleteCompany", "true");
        window.location.href = "/settings?section=my-companies";
      } else {
        const errorText = await response.text();
        alert("Erro ao excluir empresa: " + errorText);
      }
    } catch (err) {
      console.error("Erro ao eliminar:", err);
      alert("Erro interno ao tentar excluir empresa.");
    } finally {
      closeModal();
    }
  }
</script>
